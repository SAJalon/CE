<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“–æ§åˆ¶å·¥ç¨‹è‡ªå­¦æŒ‡å—</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.5.7/dist/purify.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; line-height: 1.7; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .toc { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .chapter h3 { color: #2980b9; margin-top: 0; }
    .section-list a { display: block; margin: 4px 0; color: #16a085; text-decoration: none; padding: 2px 0; }
    .section-list a:hover { color: #e74c3c; }
    #content { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .loading { color: #7f8c8d; font-style: italic; }
  </style>
</head>
<body>
  <h1>ğŸ“–CEBOOK</h1>

  <div class="toc" id="toc">
    <p class="loading">åŠ è½½ç›®å½•ä¸­...</p>
  </div>

  <div id="content">
    <p>ç‚¹å‡»å·¦ä¾§ç« èŠ‚å¼€å§‹é˜…è¯»ã€‚</p>
  </div>

  <script>
    const username = 'SAJalon';
    const repo = 'CE';
    const baseUrl = `https://api.github.com/repos/${username}/${repo}/contents`;

    // âœ… å®‰å…¨çš„ ID ç”Ÿæˆå‡½æ•°ï¼šå¤„ç†ä¸­æ–‡å’Œç‰¹æ®Šå­—ç¬¦
    function createId(path) {
      return 'link-' + btoa(encodeURIComponent(path)).replace(/=/g, '');
    }

    // è·å–æ ¹ç›®å½•
    fetch(baseUrl)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) {
          throw new Error('ä»“åº“ä¸å­˜åœ¨æˆ–ä¸ºç§æœ‰');
        }

        const folders = data.filter(item => item.type === 'dir').sort((a, b) => a.name.localeCompare(b.name));
        const tocContainer = document.getElementById('toc');
        tocContainer.innerHTML = '';

        folders.forEach(folder => {
          const chapterHtml = `
            <div class="chapter">
              <h3>${folder.name}</h3>
              <div class="section-list" id="list-${folder.name}">
                <p class="loading">åŠ è½½ä¸­...</p>
              </div>
            </div>
          `;
          tocContainer.insertAdjacentHTML('beforeend', chapterHtml);

          fetch(`${baseUrl}/${encodeURIComponent(folder.name)}?ref=main`)
            .then(res => res.json())
            .then(files => {
              const mdFiles = files
                .filter(file => file.name.endsWith('.md'))
                .sort((a, b) => a.name.localeCompare(b.name));

              const listContainer = document.getElementById(`list-${folder.name}`);
              if (mdFiles.length === 0) {
                listContainer.innerHTML = '<em>æš‚æ— å†…å®¹</em>';
                return;
              }

              const fileLinks = mdFiles.map(file => {
                const filePath = `${folder.name}/${file.name}`;
                const title = file.name.replace(/\.md$/, '').replace(/^\d+-/, '').trim();
                const linkId = createId(filePath); // âœ… ä½¿ç”¨å®‰å…¨çš„ ID ç”Ÿæˆ

                return `<a id="${linkId}" href="#" onclick="loadContent('${file.download_url}', '${linkId}'); return false;">${title}</a>`;
              }).join('');

              listContainer.innerHTML = fileLinks;
            })
            .catch(err => {
              listContainer.innerHTML = '<em>åŠ è½½å¤±è´¥</em>';
              console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', err);
            });
        });
      })
      .catch(err => {
        document.getElementById('toc').innerHTML = `<p style="color:red;">åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
        console.error('è·å–ä»“åº“å†…å®¹å¤±è´¥:', err);
      });

    // åŠ è½½å†…å®¹
    function loadContent(url, linkId) {
      const contentDiv = document.getElementById('content');
      contentDiv.innerHTML = '<p class="loading">åŠ è½½å†…å®¹ä¸­...</p>';

      fetch(url)
        .then(res => res.text())
        .then(text => {
          contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(text));

          // é«˜äº®å½“å‰ç« èŠ‚
          document.querySelectorAll('.section-list a').forEach(a => a.style.fontWeight = 'normal');
          const linkEl = document.getElementById(linkId);
          if (linkEl) linkEl.style.fontWeight = 'bold';
        })
        .catch(err => {
          contentDiv.innerHTML = '<p style="color:red;">åŠ è½½å¤±è´¥</p>';
          console.error('åŠ è½½å†…å®¹å¤±è´¥:', err);
        });
    }
  </script>
</body>
</html>
