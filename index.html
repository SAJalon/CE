<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>📖控制工程自学指南</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.5.7/dist/purify.min.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; line-height: 1.7; color: #333; max-width: 900px; margin: 0 auto; padding: 20px; }
    h1 { text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
    .toc { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    .chapter h3 { color: #2980b9; margin-top: 0; }
    .section-list a { display: block; margin: 4px 0; color: #16a085; text-decoration: none; padding: 2px 0; }
    .section-list a:hover { color: #e74c3c; }
    #content { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .loading { color: #7f8c8d; font-style: italic; }
  </style>
</head>
<body>
  <h1>📖CEBOOK</h1>

  <div class="toc" id="toc">
    <p class="loading">加载目录中...</p>
  </div>

  <div id="content">
    <p>点击左侧章节开始阅读。</p>
  </div>

  <script>
    const username = 'SAJalon';
    const repo = 'CE';
    const baseUrl = `https://api.github.com/repos/${username}/${repo}/contents`;

    // ✅ 安全的 ID 生成函数：处理中文和特殊字符
    function createId(path) {
      return 'link-' + btoa(encodeURIComponent(path)).replace(/=/g, '');
    }

    // 获取根目录
    fetch(baseUrl)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) {
          throw new Error('仓库不存在或为私有');
        }

        const folders = data.filter(item => item.type === 'dir').sort((a, b) => a.name.localeCompare(b.name));
        const tocContainer = document.getElementById('toc');
        tocContainer.innerHTML = '';

        folders.forEach(folder => {
          const chapterHtml = `
            <div class="chapter">
              <h3>${folder.name}</h3>
              <div class="section-list" id="list-${folder.name}">
                <p class="loading">加载中...</p>
              </div>
            </div>
          `;
          tocContainer.insertAdjacentHTML('beforeend', chapterHtml);

          fetch(`${baseUrl}/${encodeURIComponent(folder.name)}?ref=main`)
            .then(res => res.json())
            .then(files => {
              const mdFiles = files
                .filter(file => file.name.endsWith('.md'))
                .sort((a, b) => a.name.localeCompare(b.name));

              const listContainer = document.getElementById(`list-${folder.name}`);
              if (mdFiles.length === 0) {
                listContainer.innerHTML = '<em>暂无内容</em>';
                return;
              }

              const fileLinks = mdFiles.map(file => {
                const filePath = `${folder.name}/${file.name}`;
                const title = file.name.replace(/\.md$/, '').replace(/^\d+-/, '').trim();
                const linkId = createId(filePath); // ✅ 使用安全的 ID 生成

                return `<a id="${linkId}" href="#" onclick="loadContent('${file.download_url}', '${linkId}'); return false;">${title}</a>`;
              }).join('');

              listContainer.innerHTML = fileLinks;
            })
            .catch(err => {
              listContainer.innerHTML = '<em>加载失败</em>';
              console.error('加载章节失败:', err);
            });
        });
      })
      .catch(err => {
        document.getElementById('toc').innerHTML = `<p style="color:red;">加载失败：${err.message}</p>`;
        console.error('获取仓库内容失败:', err);
      });

    // 加载内容
    function loadContent(url, linkId) {
      const contentDiv = document.getElementById('content');
      contentDiv.innerHTML = '<p class="loading">加载内容中...</p>';

      fetch(url)
        .then(res => res.text())
        .then(text => {
          contentDiv.innerHTML = DOMPurify.sanitize(marked.parse(text));

          // 高亮当前章节
          document.querySelectorAll('.section-list a').forEach(a => a.style.fontWeight = 'normal');
          const linkEl = document.getElementById(linkId);
          if (linkEl) linkEl.style.fontWeight = 'bold';
        })
        .catch(err => {
          contentDiv.innerHTML = '<p style="color:red;">加载失败</p>';
          console.error('加载内容失败:', err);
        });
    }
  </script>
</body>
</html>
